<!DOCTYPE html>
<HTML lang="ja">
<HEAD>
<meta http-equiv="Content-Type" content="text/html; charset=utf_8">
<script src="gamedata.js"></script>
<script src="canvaslib.js"></script>
<script src="draw.js"></script>
<script src="events.js"></script>
<script type="text/javascript">
var is_started=0;
var tm;
var is_end=0;
var keyevents=new Array();
var started_time;

var attack_count=0;
var attack_list_size=0;
var attack_from=new Array();
var attack_to=new Array();
var attack_id=new Array();
var attack_power=new Array();
var attack_status=new Array();

function start_attack(from,to,id,power)
{
	if(id==AI_ID&&flag[from]==flag[to]&&flag[from]==AI_ID&&city_power[to]+power>Math.max(0.3*enemy_power,600000))return;
	if(id==AI_ID&&to>=49)return;
	//if(id==AI_ID)return;
	var sa_power;
	if(flag[from]==id)sa_power=city_power[from];
	else sa_power=city_rebels[from];
	power=parseInt((power+999)/1000)*1000;
	if(id==PLAYER_ID&&power>sa_power-2.0)power=sa_power-2.0;
	if(id==AI_ID&&power>sa_power-2000)power=sa_power-2000;
	if(id==AI_ID&&sa_power-power<2000*city_size[from]*city_size[from])return;
	if(power<0)return;
	
//	console.log("attack -- "+from+" => "+to+" "+id+" "+power);
	
	if(flag[from]==id)city_power[from]-=power;
	else city_rebels[from]-=power;
	attack_from.push(from);
	attack_to.push(to);
	attack_id.push(id);
	attack_power.push(power);
	attack_status.push(0);
	attack_list_size++;
}
var ai_call_num=0;
var ai_tmp=new Array(city_num);
var ai_usd=new Array(city_num);
function ai_call()
{
	ai_call_num++;
	if(ai_call_num<=e_start)return;
	for(__=0;__<2;__++)
	{
	
	for(i=0;i<city_num;i++)ai_tmp[i]=10000;
	for(i=0;i<city_num;i++)if(flag[i]==AI_ID)
	{
		if(city_rebels[i]>city_power[i]*0.5)continue;
		if(city_power[i]<1000*city_size[i]*city_size[i])continue;
		ai_usd[i]=0;
		for(var tmp_for_j in G[i])
		{
			var j=G[i][tmp_for_j];
			if(j>=49)continue;
			if(flag[j]==PLAYER_ID)
			{
				if(attack_time[j]<ai_call_num-3&&city_rebels[j]<city_power[j]*0.6/*&&(city_power[j]<20000||city_power[j]-city_rebels[j]<city_power[j]*0.9)*/)
				{
					if(bisieged[j]==0&&city_power[j]>city_power[i]*2.0*save_power[i])continue;
					if(bisieged[j]>0&&city_power[j]*save_power[j]>bisieged[j]*1.0)continue;
					attack_time[j]=ai_call_num;
					if(city_power[j]*save_power[j]<city_power[i]+city_rebels[j])
						start_attack(i,j,1,Math.max(4000,Math.min(city_power[i]/2,city_power[j]*1.2)));
					ai_usd[i]=1;
					ai_tmp[i]=1;
					//if(city_size>2&&city_power[i]<20000)ai_tmp[i]-=12.02;
				}
				else if(city_rebels[j]<city_power[j]*0.6)ai_tmp[i]=320;
				
				
				ai_tmp[i]-=(city_size[i])*0.001;
			}
			else if(city_power[j]==0)
			{
				start_attack(i,j,1,2000);
				ai_usd[i]=1;
			}
			else if(city_rebels[i]>0)ai_usd[i]=1;
		}
	}	
	for(_=0;_<city_num;_++)for(k=0;k<city_num;k++)for(var tmp_for_j in G[k])
	{
		var j=G[k][tmp_for_j];
		if(j>=49||k>=49)continue;
		ai_tmp[j]=Math.min(ai_tmp[j],ai_tmp[k]+1);
	}
	for(i=0;i<city_num;i++)if(flag[i]==AI_ID)
	{
		if(city_power[i]<1000*city_size[i]*city_size[i])continue;
		if(ai_usd[i]==0)
		{
			var ccc=0;
			for(var tmp_for_j in G[i])
			{
				var j=G[i][tmp_for_j];
				if(j>=49)continue;
				if(ai_tmp[i]>ai_tmp[j])ccc++;
			}
			for(var tmp_for_j in G[i])
			{
				var j=G[i][tmp_for_j];
				if(j>=49)continue;
				if(ai_tmp[i]>ai_tmp[j])
				{
					if(ccc==1)
					{
						//if(flag[j]!=AI_ID&&city_power[j]*0.5<city_rebels[i]+city_power[i])continue;
						if(flag[j]==PLAYER_ID&&save_power[j]>2&&save_power[j]*city_power[j]>bisieged2[j])continue;
						start_attack(i,j,AI_ID,Math.max(3000,city_power[i]*0.1));
					}
					else ccc--;
				}
			}
		}
	}
	for(i=0;i<city_num;i++)if(flag[i]==PLAYER_ID&&city_rebels[i]>1&&city_rebels[i]<city_power[i]*0.5&&i<49)
	{
		var sp=0,se=0;
		for(var tmp_for_j in G[i])
		{
			var j=G[i][tmp_for_j];
			if(j>=49)continue;
			if(flag[j]==PLAYER_ID)sp+=city_power[j],se+=city_rebels[j];
			else sp+=city_rebels[j],se+=city_power[j];
		}
		sp+=city_power[j];
		se+=city_rebels[j];
		if(se<sp*0.5)
		{
			var nxt=-1;
			for(var tmp_for_j in G[i])
			{
				var j=G[i][tmp_for_j];
				if(j>=49)continue;
				if((nxt==-1||ai_tmp[nxt]<ai_tmp[j])&&flag[j]==AI_ID)nxt=j;
			}
			if(nxt==-1)continue;
			start_attack(i,nxt,AI_ID,city_rebels[i]);
		}
	}
	
	
	}
}
function do_attack()
{
	attack_count++;
	var do_attack_ptr=0;
	if(attack_count%5!=0)return;
	for(i=0;i<attack_list_size;i++)
	{
		if(attack_power[i]==0)
		{
			attack_from.splice(i,1);
			attack_to.splice(i,1);
			attack_id.splice(i,1);
			attack_power.splice(i,1);
			attack_status.splice(i,1);
			attack_list_size--;
			i--;
			continue;		
		}
		attack_status[i]+=25;
		//if(attack_id[i]==PLAYER_ID)attack_status[i]+=200;
		var f=attack_from[i],t=attack_to[i];
		if(attack_power[i]>0.0001&&city_udist[f][t]<=attack_status[i])
		{
			if(attack_id[i]==flag[t])
			{
				city_power[t]+=attack_power[i];
				attack_power[i]=0;
			}
			else
			{
				city_rebels[t]+=attack_power[i];
				attack_power[i]=0;
			}
		}
		else
		{
			//if(attack_count%25==0)attack_power[i]*=0.94;
			/*attack_power[i]=parseInt(attack_power[i]);
			attack_from[i]=attack_from[do_attack_ptr];
			attack_to[i]=attack_to[do_attack_ptr];
			attack_id[i]=attack_id[do_attack_ptr];
			attack_power[i]=attack_power[do_attack_ptr];
			attack_status[i]=attack_status[do_attack_ptr];
			do_attack_ptr++;*/
		}
	}
	/*for(i=0;i<attack_list_size-do_attack_ptr;i++)
	{
		if(attack_power[i]!=0)break;
		attack_from.pop();
		attack_to.pop();
		attack_id.pop();
		attack_power.pop();
		attack_status.pop();
	}
	attack_list_size=do_attack_ptr;*/
	if(attack_count%5==0)do_rebels();
}
function do_rebels()
{
	for(i=0;i<city_num;i++)
	{
		bisieged2[i]=bisieged[i];
		bisieged[i]=0;
		//version 1 start--
		
		/*
		
		if(city_size[i]>1)
		{
			if(city_rebels[i]<city_power[i]/4)city_power[i]=parseInt(city_power[i]*1.002);
			//city_power[i]=Math.min(city_power[i],300000);
			city_rebels[i]*=1.01;
			city_power[i]*=1.02;
		}
		var rebels_tmp=0;
		for(tmp_for_j in G[i])
		{
			var j=G[i][tmp_for_j];
			if(flag[i]==flag[j])rebels_tmp=1;
		}
		if(rebels_tmp==0)
		{
			city_power[i]=parseInt(city_power[i]*0.99);
		}
		
		if(city_rebels[i])
		{
			var tmp1=Math.max(0,parseInt(city_power[i]/20*Math.random()));
			tmp1=Math.min(tmp1,parseInt(city_rebels[i]/5));
			var tmp2=Math.max(0,parseInt(city_rebels[i]/20*Math.random()));
			tmp2=Math.min(tmp2,parseInt(city_power[i]/5));
			city_rebels[i]-=tmp1;
			city_power[i]-=tmp2;
			if(city_rebels[i]<500)city_rebels[i]=0;
			if(city_rebels[i]<0)city_rebels[i]=0;
			if(city_power[i]<0)city_power[i]=0;
			if(city_power[i]<city_rebels[i])
			{
				tmp1=city_power[i];
				city_power[i]=city_rebels[i];
				city_rebels[i]=tmp1;
				flag[i]=1-flag[i];
			}
			if(city_rebels[i]<500)city_rebels[i]=0;
			if(city_rebels[i]<0)city_rebels[i]=0;
			if(city_power[i]<0)city_power[i]=0;
			if(city_rebels[i]==0)city_power[i]=Math.max(city_power[i],500);
		}
		
		*/
		// version 1 end --
		
		// version 2 start--
		var rebels_tmp=0;
		var ssmm=0;
		var safe_area=0;
		for(tmp_for_j in G[i])
		{
			var j=G[i][tmp_for_j];
			if(flag[i]==flag[j])rebels_tmp=1;
			else ssmm+=city_power[j];
			if(flag[i]!=flag[j])safe_area=1;
		}
		if(rebels_tmp==0&&ai_call_num>e_start&&city_power[i]>0)//包囲状態
		{
			var del=parseInt(city_power[i]*(0.98+(0.00125*city_size[i])));
			if(del==0)del=1;
			del=city_power[i]-del;
			if(save_power[i]>1)del/=save_power[i];
			city_power[i]-=del;
			del*=besiege_pw;
			var cnt=0;
			for(tmp_for_j in G[i])cnt++;
			for(tmp_for_j in G[i])
			{
				var j=G[i][tmp_for_j];
				city_power[j]+=del/cnt;
			}
			bisieged[i]=ssmm;
		}
		if(safe_area==0&&ai_call_num>e_start&&city_rebels[i]>0)
		{
			var del=parseInt(city_rebels[i]*(0.98+(0.00125*city_size[i])));
			if(del==0)del=1;
			del=city_rebels[i]-del;
			city_rebels[i]-=del;
			del*=0.3;
			
			var cnt=0;
			for(tmp_for_j in G[i])cnt++;
			for(tmp_for_j in G[i])
			{
				var j=G[i][tmp_for_j];
				city_power[j]+=del/cnt;
			}
		}
		
		if(city_rebels[i])
		{
			var tmp1=Math.max(0,parseInt(city_power[i]/40*Math.random()))*save_power[i]*Math.random();
			var tmp2=Math.max(0,parseInt(city_rebels[i]/40*Math.random()));
			city_rebels[i]-=tmp1;
			city_power[i]-=tmp2;
			if(city_rebels[i]<500)city_rebels[i]=0;
			if(city_rebels[i]<0)city_rebels[i]=0;
			if(city_power[i]<0)city_power[i]=0;
			if(city_power[i]<city_rebels[i]*0.5)
			{
				var ttt=city_power[i];
				city_power[i]=city_rebels[i];
				city_rebels[i]=ttt;
				flag[i]=1-flag[i];
			}
			city_rebels[i]+=tmp2*0.3;
			city_power[i]+=tmp1*0.3/save_power[i];
			if(city_rebels[i]<500)city_rebels[i]=0;
			if(city_rebels[i]<0)city_rebels[i]=0;
			if(city_power[i]<0)city_power[i]=0;
			if(city_rebels[i]==0)city_power[i]=Math.max(city_power[i],500);
		}
		// version 2 end--
	}
}

</script>
<TITLE></TITLE>
</HEAD>
<BODY>
<noscript>
このページはJavaScriptを使用しております。JavaScriptを有効にしてください。
</noscript>
<canvas id="game" width="600" height="587" style="float:left;"></canvas>
<SCRIPT type="text/javascript">
var cvs = document.getElementById("game");
if (!cvs.getContext)
	document.write("Canvasに対応していないので表示できません<BR>");
else
{
	var c = cvs.getContext("2d");
	bgimg=new Image();
	bgimg.src="map.png";
	bgimg.onload=function()
	{
		draw(0);
	}
}
</SCRIPT>
<div style="float:right; pointer-events:none;">
<br>
赤が自分、灰色が敵、丸が重要拠点、オレンジ色の線が道です。<br>
川より下の部分は敵が攻めてこないです。<br>
重要拠点は復活拠点でもあります。<br>
復活拠点としての能力は拠点の大きさに依存します。<br>
自分の戦力がほとんどなくなったときに戦力を一番下の大きな拠点に集めるとよいことが起こるでしょう。<br>
自分の戦力がある重要拠点から、隣の重要拠点まで、<br>
　一度のクリック後のドラッグなら小規模の戦力<br>
　二度のクリック後のドラッグなら戦力の半分<br>
　三度以上のクリック後のドラッグなら可能な全戦力<br>
を移動することができます。<br><br>
<br>
制限時間は25分です<br>

いろいろなバグがあるかもしれませんが、お許しください。<br>
</BODY>
</div>
</HTML>
